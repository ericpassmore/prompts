# Auto-allow a small, explicit set of git read/write commands commonly used
# by commit/pull workflows. Rules are exact-prefix matches over argv.

# -----------------------
# Branch / status / fetch
# -----------------------

prefix_rule(
    pattern = ["git", "branch", "--show-current"],
    decision = "allow",
    justification = "Read current branch name for safety checks.",
    match = ["git branch --show-current"],
)

prefix_rule(
    pattern = ["git", "status", "--porcelain"],
    decision = "allow",
    justification = "List working tree changes in machine-readable form.",
    match = ["git status --porcelain"],
)

prefix_rule(
    pattern = ["git", "fetch", "--prune"],
    decision = "allow",
    justification = "Fetch remote updates without modifying working files.",
    match = ["git fetch --prune"],
)

# -----------------------
# Diff / inspection
# -----------------------

prefix_rule(
    pattern = ["git", "diff"],
    decision = "allow",
    justification = "Inspect changes (unstaged/staged depending on flags).",
    match = [
        "git diff",
        "git diff --cached",
        "git diff --cached --name-only -z",
        "git diff --cached --numstat -- path/to/file",
        "git diff --cached -- path/to/file",
    ],
)

prefix_rule(
    pattern = ["git", "diff", "--name-only", "--diff-filter=U"],
    decision = "allow",
    justification = "List conflicted/unmerged paths only.",
    match = ["git diff --name-only --diff-filter=U"],
)

# -----------------------
# Upstream / divergence checks
# -----------------------

prefix_rule(
    pattern = ["git", "rev-parse", "--abbrev-ref", "--symbolic-full-name", "@{u}"],
    decision = "allow",
    justification = "Resolve upstream tracking ref for current branch.",
    match = ["git rev-parse --abbrev-ref --symbolic-full-name @{u}"],
)

prefix_rule(
    pattern = ["git", "rev-list", "--left-right", "--count", "HEAD...@{u}"],
    decision = "allow",
    justification = "Compute ahead/behind counts vs upstream.",
    match = ["git rev-list --left-right --count HEAD...@{u}"],
)

# -----------------------
# Pull / push (scoped)
# -----------------------

prefix_rule(
    pattern = ["git", "pull", "--ff-only"],
    decision = "allow",
    justification = "Fast-forward-only pull; never creates merges.",
    match = [
        "git pull --ff-only",
        "git pull --ff-only origin feature-branch",
    ],
)

prefix_rule(
    pattern = ["git", "push", "origin"],
    decision = "allow",
    justification = "Push to origin; branch name follows as argument.",
    match = ["git push origin feature-branch"],
)

# -----------------------
# Commit (scoped)
# -----------------------

prefix_rule(
    pattern = ["git", "commit"],
    decision = "allow",
    justification = "Commit changes locally.",
    match = [
        "git commit",
        "git commit path/to/file",
    ],
)

# -----------------------
# Tracking / staging helpers (scoped)
# -----------------------

prefix_rule(
    pattern = ["git", "ls-files", "-o", "--exclude-standard"],
    decision = "allow",
    justification = "List untracked files excluding standard ignores.",
    match = ["git ls-files -o --exclude-standard"],
)

prefix_rule(
    pattern = ["git", "add"],
    decision = "allow",
    justification = "Add all files and stage to git.",
    match = ["git add -A","git add path/to/file",],
)

prefix_rule(
    pattern = ["git", "rm", "--cached"],
    decision = "allow",
    justification = "Stop tracking a file without deleting it from disk.",
    match = ["git rm --cached path/to/file"],
)

# -----------------------
# Worktree lifecycle
# -----------------------

prefix_rule(
    pattern = ["git", "worktree", "list", "--porcelain"],
    decision = "allow",
    justification = "List worktrees for deterministic workspace release.",
    match = ["git worktree list --porcelain"],
)

prefix_rule(
    pattern = ["git", "worktree", "remove"],
    decision = "allow",
    justification = "Release non-primary task worktrees during landing.",
    match = ["git worktree remove /path/to/worktree"],
)

prefix_rule(
    pattern = ["git", "worktree", "prune"],
    decision = "allow",
    justification = "Prune stale worktree metadata after release.",
    match = ["git worktree prune"],
)

# -----------------------
# GitHub PR handoff
# -----------------------

prefix_rule(
    pattern = ["gh", "pr", "create"],
    decision = "allow",
    justification = "Create reviewer-facing pull requests during land-the-plan.",
    match = [
        "gh pr create --base main --head feature-branch --title T --body-file /tmp/pr-body.md",
    ],
)

prefix_rule(
    pattern = ["gh", "pr", "edit"],
    decision = "allow",
    justification = "Update an existing pull request instead of creating duplicates.",
    match = [
        "gh pr edit 123 --title T --body-file /tmp/pr-body.md",
        "gh pr edit --title T --body-file /tmp/pr-body.md",
    ],
)

prefix_rule(
    pattern = ["gh", "pr", "view"],
    decision = "allow",
    justification = "Read existing pull request metadata for handoff details.",
    match = [
        "gh pr view",
        "gh pr view --json url",
    ],
)

# ----------------------
# Auto-allow trusted helper scripts (exact path prefix)
# ----------------------

prefix_rule(
    pattern = ["/Users/eric/.codex/scripts/git-check-conflicts.sh"],
    decision = "allow",
    justification = "Trusted helper script to detect merge conflicts safely.",
    match = [
        "/Users/eric/.codex/scripts/git-check-conflicts.sh",
    ],
)

prefix_rule(
    pattern = ["/Users/eric/.codex/scripts/git-diff-staged-skip-binary.sh"],
    decision = "allow",
    justification = "Trusted helper script to diff staged files while skipping binaries.",
    match = [
        "/Users/eric/.codex/scripts/git-diff-staged-skip-binary.sh",
    ],
)

prefix_rule(
    pattern = ["/Users/eric/.codex/scripts/git-commit-preflight.sh"],
    decision = "allow",
    justification = "Trusted helper script for git-commit preflight safety checks and fast-forward sync.",
    match = [
        "/Users/eric/.codex/scripts/git-commit-preflight.sh",
    ],
)

prefix_rule(
    pattern = ["./.codex/scripts/git-commit-preflight.sh"],
    decision = "allow",
    justification = "Trusted helper script for git-commit preflight checks (canonical repo path).",
    match = [
        "./.codex/scripts/git-commit-preflight.sh",
    ],
)

prefix_rule(
    pattern = ["./codex/scripts/git-commit-preflight.sh"],
    decision = "allow",
    justification = "Trusted helper script for git-commit preflight checks (repo-local fallback path).",
    match = [
        "./codex/scripts/git-commit-preflight.sh",
    ],
)

prefix_rule(
    pattern = ["/Users/eric/.codex/scripts/git-track-safe-untracked.sh"],
    decision = "allow",
    justification = "Trusted helper script to apply git-commit track-file policies and stage intent-to-add safely.",
    match = [
        "/Users/eric/.codex/scripts/git-track-safe-untracked.sh",
    ],
)

prefix_rule(
    pattern = ["./.codex/scripts/git-track-safe-untracked.sh"],
    decision = "allow",
    justification = "Trusted helper script to apply git-commit track-file policies (canonical repo path).",
    match = [
        "./.codex/scripts/git-track-safe-untracked.sh",
    ],
)

prefix_rule(
    pattern = ["./codex/scripts/git-track-safe-untracked.sh"],
    decision = "allow",
    justification = "Trusted helper script to apply git-commit track-file policies (repo-local fallback path).",
    match = [
        "./codex/scripts/git-track-safe-untracked.sh",
    ],
)

prefix_rule(
    pattern = ["/Users/eric/.codex/scripts/prepare-takeoff-worktree.sh"],
    decision = "allow",
    justification = "Trusted helper script to create task worktrees under $HOME/workspace.",
    match = [
        "/Users/eric/.codex/scripts/prepare-takeoff-worktree.sh add-feature-x",
        "/Users/eric/.codex/scripts/prepare-takeoff-worktree.sh add-feature-x feature/add-feature-x",
    ],
)

prefix_rule(
    pattern = ["./.codex/scripts/prepare-takeoff-worktree.sh"],
    decision = "allow",
    justification = "Trusted helper script to create task worktrees under $HOME/workspace (canonical repo path).",
    match = [
        "./.codex/scripts/prepare-takeoff-worktree.sh add-feature-x",
        "./.codex/scripts/prepare-takeoff-worktree.sh add-feature-x feature/add-feature-x",
    ],
)

prefix_rule(
    pattern = ["./codex/scripts/prepare-takeoff-worktree.sh"],
    decision = "allow",
    justification = "Trusted helper script to create task worktrees under $HOME/workspace (repo-local fallback path).",
    match = [
        "./codex/scripts/prepare-takeoff-worktree.sh add-feature-x",
        "./codex/scripts/prepare-takeoff-worktree.sh add-feature-x feature/add-feature-x",
    ],
)
